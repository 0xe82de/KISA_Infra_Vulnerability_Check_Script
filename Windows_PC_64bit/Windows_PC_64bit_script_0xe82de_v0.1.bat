@echo off

REM On Windows 10, the script below can be successful without administrator privileges.
REM In other words, it is inappropriate to verify that the batch file was run with administrator privileges.
REM >nul 2>&1 "%SYSTEMROOT%\system32\cacls.exe" "%SYSTEMROOT%\system32\config\system"

REM Use the bcddit command to verify that administrator privileges are executed.
bcdedit
if '%errorlevel%' NEQ '0' (
  echo "Execute Admin Priv"
  goto GetAdmin
) else ( goto GotAdmin )
:GetAdmin
  echo Set UAC = CreateObject^("Shell.Application"^) > "%temp%\getAdmin.vbs"
  set params = %*:"=""
  echo UAC.ShellExecute "cmd.exe", "/c %~s0 %params%", "", "runas", 1 >> "%temp%\getAdmin.vbs"
  "%temp%\getAdmin.vbs"
  del "%temp%\getAdmin.vbs"
  exit /B
:GotAdmin

pushd "%CD%"
  CD /D "%~dp0"

setlocal
chcp 949

set "scriptResult=.\%COMPUTERNAME%.txt"

echo ################################################################# >> %scriptResult%
echo ##### Windows PC 64bit Check script Ver. "0.1" by "0xe82de" ##### >> %scriptResult%
echo ################################################################# >> %scriptResult%

echo. >> %scriptResult%

echo ##### start >> %scriptResult%
date /t >> %scriptResult%
time /t >> %scriptResult%
echo. >> %scriptResult%

echo ##### ipconfig /all >> %scriptResult%
ipconfig /all >> %scriptResult%
echo. >> %scriptResult%

echo ##### netstat -an >> %scriptResult%
c:\windows\system32\netstat -an >> %scriptResult%
echo. >> %scriptResult%

echo ##### systeminfo >> %scriptResult%
systeminfo >> %scriptResult%
echo. >> %scriptResult%

echo ##### PC-01 >> %scriptResult%
echo ##### 양호 : 최대 암호 사용 기간이 "90일" 이하로 설정되어 있는 경우 >> %scriptResult%
echo ##### MaximumPasswordAge ^<= 90 >> %scriptResult%
echo ##### 취약 : 암호 사용 기간이 "제한" 없음이거나 "90일"을 초과하여 설정되어 있는 경우 >> %scriptResult%
echo ##### MaximumPasswordAge ^> 90 or -1 >> %scriptResult%
echo. >>%scriptResult%

secedit /EXPORT /CFG SEC.txt
type SEC.txt | find "MaximumPasswordAge =" >> %scriptResult%
echo. >> %scriptResult%

echo 고려사항 : 최근 암호기억(24개), 최소 암호 사용기간(1일) >> %scriptResult%
type SEC.txt | find "PasswordHistorySize =" >> %scriptResult%
type SEC.txt | find "MinimumPasswordAge =" >> %scriptResult%
echo. >> %scriptResult%

echo ##### PC-02 >> %scriptResult%
echo ##### 양호 : 최소 암호 길이가 해당 기관의 보안 정책을 반영하여 설정되어 있는 경우 >> %scriptResult%
echo ##### MinimumPasswordAge ^>= 8 >> %scriptResult%
echo ##### 취약 : 암호를 사용하지 않거나, 추측하기 쉬운 문자조합으로 이루어진 짧은 자릿수의 패스워드를 사용하는 경우 >> %scriptResult%
echo ##### MinimumPasswordAge ^< 8 >> %scriptResult%
echo. >> %scriptResult%

type SEC.txt | find "MinimumPasswordLength =" >> %scriptResult%
echo. >> %scriptResult%

echo ##### PC-03 >> %scriptResult%
echo ##### 양호 : 불필요한 공유 폴더가 존재하지 않거나 공유 폴더에 접근권한 및 암호가 설정되어있는 경우 >> %scriptResult%
echo ##### No results "net share" or >> %scriptResult%
echo ##### AutoShareServer    REG_DWORD    0x0 >> %scriptResult%
echo ##### AutoShareWks    REG_DWORD    0x0 >> %scriptResult%
echo ##### 취약 : 불필요한 공유 폴더가 존재하거나 접근권한 및 암호 설정 없이 공유폴더를 사용하는 경우 >> %scriptResult%
echo ##### C$, etc, ... exist >> %scriptResult%
echo ##### AutoShareServer    REG_DWORD    !(0x0) or Non exist >> %scriptResult%
echo ##### AutoShareWks    REG_DWORD    !(0x0) or Non exist >> %scriptResult%
echo. >> %scriptResult%

echo ##### net share >> %scriptResult%
net share | find "$" | findstr /V "IPC print" >> %scriptResult%
echo. >> %scriptResult%

echo ##### registry >> %scriptResult%
reg query HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters | find "AutoShareServer" >> %scriptResult%
reg query HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters | find "AutoShareWks" >> %scriptResult%
echo. >> %scriptResult%

echo ##### PC-04 >> %scriptResult%

del SEC.txt

echo ##### end >> %scriptResult%
date /t >> %scriptResult%
time /t >> %scriptResult%
echo. >> %scriptResult%

echo ################################################## >> %scriptResult%
echo ##### Windows PC 64bit Check script Finished ##### >> %scriptResult%
echo ################################################## >> %scriptResult%
